# PDF Export System Integration Guide

## Overview
This guide explains how to integrate the new PDF export system with MindLoad branding throughout the entire MindLoad application. The system provides a unified way to export study sets to PDF with consistent branding, progress tracking, and error handling.

## üöÄ Quick Start

### 1. Basic PDF Export
```dart
import 'package:mindload/services/pdf_export_service.dart';
import 'package:mindload/models/pdf_export_models.dart';

// Simple export
final pdfService = PdfExportService();
final options = PdfExportOptions(
  setId: 'study_set_123',
  includeFlashcards: true,
  includeQuiz: false,
  style: 'standard',
  pageSize: 'Letter',
);

final result = await pdfService.exportToPdf(
  uid: 'user_123',
  setId: 'study_set_123',
  appVersion: '1.0.0',
  itemCounts: {'flashcards': 50},
  options: options,
  onProgress: (progress) {
    print('Export progress: ${progress.percentage}%');
  },
  onCancelled: () {
    print('Export cancelled');
  },
);

if (result.success) {
  print('PDF exported to: ${result.filePath}');
  print('Pages: ${result.pages}, Size: ${result.bytes} bytes');
}
```

### 2. Using the Export Button Widget
```dart
import 'package:mindload/widgets/mindload_pdf_export_button.dart';

MindloadPdfExportButton(
  setId: studySet.id,
  setTitle: studySet.title,
  flashcardCount: studySet.flashcards.length,
  quizCount: studySet.quizzes.length,
  uid: currentUser.id,
  appVersion: appVersion,
  onExportComplete: () {
    // Handle successful export
  },
  onExportError: () {
    // Handle export error
  },
)
```

## üîß Integration Points

### 1. Study Set Cards
Add export functionality to study set cards in lists and grids:

```dart
// In study set card
Row(
  children: [
    // ... other actions
    CompactMindloadPdfExportButton(
      setId: studySet.id,
      setTitle: studySet.title,
      flashcardCount: studySet.flashcards.length,
      quizCount: studySet.quizzes.length,
      uid: currentUser.id,
      appVersion: appVersion,
    ),
  ],
)
```

### 2. Study Set Detail Pages
Add export options to study set detail pages:

```dart
// In study set detail page
Column(
  children: [
    // ... study set content
    MindloadPdfExportButton(
      setId: studySet.id,
      setTitle: studySet.title,
      flashcardCount: studySet.flashcards.length,
      quizCount: studySet.quizzes.length,
      uid: currentUser.id,
      appVersion: appVersion,
    ),
  ],
)
```

### 3. Popup Menus
Add export to popup menus for study sets:

```dart
PopupMenuButton<String>(
  itemBuilder: (context) => [
    // ... other menu items
    MindloadPdfExportMenuItem(
      setId: studySet.id,
      setTitle: studySet.title,
      flashcardCount: studySet.flashcards.length,
      quizCount: studySet.quizzes.length,
      uid: currentUser.id,
      appVersion: appVersion,
    ),
  ],
)
```

### 4. Floating Action Buttons
Add export to floating action buttons:

```dart
FloatingActionButton.extended(
  onPressed: () => _showExportOptions(context),
  icon: const Icon(Icons.picture_as_pdf),
  label: const Text('Export'),
)
```

## üì± UI Components

### Available Widgets

#### 1. MindloadPdfExportButton
Full-featured export button with text label.

**Properties:**
- `setId`: Study set ID
- `setTitle`: Study set title
- `flashcardCount`: Number of flashcards
- `quizCount`: Number of quiz questions
- `uid`: User ID
- `appVersion`: App version
- `onExportComplete`: Callback for successful export
- `onExportError`: Callback for export errors

**Usage:**
```dart
MindloadPdfExportButton(
  setId: 'set_123',
  setTitle: 'Biology Chapter 1',
  flashcardCount: 25,
  quizCount: 10,
  uid: 'user_456',
  appVersion: '1.0.0',
  onExportComplete: () => print('Export successful!'),
  onExportError: () => print('Export failed!'),
)
```

#### 2. CompactMindloadPdfExportButton
Icon-only export button for compact spaces.

**Properties:** Same as MindloadPdfExportButton

**Usage:**
```dart
CompactMindloadPdfExportButton(
  setId: 'set_123',
  setTitle: 'Biology Chapter 1',
  flashcardCount: 25,
  quizCount: 10,
  uid: 'user_456',
  appVersion: '1.0.0',
)
```

#### 3. MindloadPdfExportMenuItem
Export option for popup menus.

**Properties:** Same as MindloadPdfExportButton

**Usage:**
```dart
PopupMenuButton<String>(
  itemBuilder: (context) => [
    MindloadPdfExportMenuItem(
      setId: 'set_123',
      setTitle: 'Biology Chapter 1',
      flashcardCount: 25,
      quizCount: 10,
      uid: 'user_456',
      appVersion: '1.0.0',
    ),
  ],
)
```

## üé® MindLoad Branding

### Automatic Branding
All exported PDFs automatically include MindLoad branding:

- **Header Page**: MindLoad logo, tagline, and export information
- **Footer**: "Generated by MindLoad - Your AI Learning Companion"
- **Watermark**: MindLoad branding on each page
- **Metadata**: App version and generation timestamp

### Branding Configuration
The branding is configured in `PdfExportService`:

```dart
static const Map<String, String> _brandingConfig = {
  'logo': 'MindLoad',
  'tagline': 'Transform your learning',
  'website': 'mindload.app',
  'version': '1.0.0',
  'footer': 'Generated by MindLoad - Your AI Learning Companion',
};
```

### Customizing Branding
To customize branding, modify the `_brandingConfig` in `PdfExportService`:

```dart
// In PdfExportService
static const Map<String, String> _brandingConfig = {
  'logo': 'Your Brand',
  'tagline': 'Your tagline',
  'website': 'yourwebsite.com',
  'version': '2.0.0',
  'footer': 'Generated by Your Brand',
};
```

## üìä Progress Tracking

### Progress Callbacks
The export system provides real-time progress updates:

```dart
final result = await pdfService.exportToPdf(
  // ... other parameters
  onProgress: (progress) {
    // Update UI with progress
    setState(() {
      _exportProgress = progress.percentage;
      _currentOperation = progress.currentOperation;
    });
  },
  onCancelled: () {
    // Handle cancellation
    setState(() {
      _isExporting = false;
    });
  },
);
```

### Progress Information
The `PdfExportProgress` object provides:

- `currentPage`: Current page being generated
- `totalPages`: Total pages to generate
- `currentItem`: Current item being processed
- `totalItems`: Total items to process
- `currentOperation`: Description of current operation
- `percentage`: Overall progress (0.0 to 100.0)

## üö´ Error Handling

### Error Types
The export system handles various error scenarios:

- **Rate Limiting**: Too many exports per hour
- **Concurrency**: Multiple exports at the same time
- **Storage**: Insufficient device storage
- **Cancellation**: User cancelled export
- **Validation**: Invalid export options

### Error Handling Example
```dart
try {
  final result = await pdfService.exportToPdf(/* ... */);
  
  if (result.success) {
    // Handle success
    _showSuccessMessage(result);
  } else {
    // Handle failure
    _showErrorMessage(result.errorMessage ?? 'Export failed');
  }
} catch (e) {
  // Handle exceptions
  _showErrorMessage('Export error: ${e.toString()}');
}
```

## üîí Rate Limiting & Concurrency

### Rate Limits
- **Exports per hour**: 5 per user
- **Concurrent exports**: 1 per user
- **Cooldown period**: 1 hour between exports

### Checking Limits
```dart
final pdfService = PdfExportService();

// Check if user can export
if (pdfService.canExport(userId)) {
  // Proceed with export
} else {
  // Show cooldown message
  final timeUntilNext = pdfService.getTimeUntilNextExport(userId);
  _showCooldownMessage(timeUntilNext);
}
```

## üìÅ File Management

### Export Locations
- **Temporary files**: `.part.pdf` during generation
- **Final files**: `exports/` directory in app documents
- **File naming**: `{setId}_{timestamp}.pdf`

### File Cleanup
The system automatically cleans up old export files:

```dart
// Clean up files older than 30 days
final deletedCount = await pdfService.cleanupOldExports();
print('Cleaned up $deletedCount old export files');
```

## üß™ Testing

### Running Tests
```bash
# Run all PDF export tests
flutter test test/pdf_export_test.dart

# Run storage service tests
flutter test test/storage_service_test.dart

# Run specific test group
flutter test test/pdf_export_test.dart --name="Unit Tests"
```

### Test Categories
- **Unit Tests**: Core functionality validation
- **Property-based Tests**: Edge case testing
- **E2E Tests**: User workflow simulation
- **Audit Tests**: Data integrity verification

## üîÑ Migration from Old System

### Old Export Methods
The old export methods are still available for backward compatibility:

```dart
// Old way (still works)
await PdfExportService.exportFlashcardsAsPdf(studySet);
await PdfExportService.exportQuizzesAsPdf(studySet);
```

### New Export Methods
```dart
// New way (recommended)
final pdfService = PdfExportService();
final result = await pdfService.exportToPdf(/* ... */);
```

### Migration Checklist
- [ ] Replace old export calls with new system
- [ ] Add progress tracking where appropriate
- [ ] Implement proper error handling
- [ ] Add export buttons to UI components
- [ ] Test export functionality in all screens

## üì± Integration Examples

### 1. Home Screen Integration
```dart
// In home screen study set list
ListTile(
  title: Text(studySet.title),
  trailing: Row(
    mainAxisSize: MainAxisSize.min,
    children: [
      CompactMindloadPdfExportButton(
        setId: studySet.id,
        setTitle: studySet.title,
        flashcardCount: studySet.flashcards.length,
        quizCount: studySet.quizzes.length,
        uid: currentUser.id,
        appVersion: appVersion,
      ),
      // ... other actions
    ],
  ),
)
```

### 2. Study Screen Integration
```dart
// In study screen actions
AppBar(
  actions: [
    MindloadPdfExportButton(
      setId: currentStudySet.id,
      setTitle: currentStudySet.title,
      flashcardCount: currentStudySet.flashcards.length,
      quizCount: currentStudySet.quizzes.length,
      uid: currentUser.id,
      appVersion: appVersion,
    ),
  ],
)
```

### 3. Export Screen Integration
```dart
// In export screen
Column(
  children: [
    // ... export options
    MindloadPdfExportButton(
      setId: widget.studySetId,
      setTitle: widget.studySetTitle,
      flashcardCount: 50, // Get from actual data
      quizCount: 25, // Get from actual data
      uid: currentUser.id,
      appVersion: appVersion,
    ),
  ],
)
```

## üéØ Best Practices

### 1. User Experience
- **Always show progress**: Use progress callbacks to update UI
- **Handle errors gracefully**: Show clear error messages
- **Provide feedback**: Confirm successful exports
- **Allow cancellation**: Let users cancel long exports

### 2. Performance
- **Use background processing**: Don't block UI during export
- **Implement rate limiting**: Prevent abuse
- **Clean up files**: Remove old exports automatically
- **Optimize memory**: Process content in chunks

### 3. Branding
- **Consistent appearance**: Use MindLoad branding everywhere
- **Professional output**: Ensure high-quality PDFs
- **Brand recognition**: Make exports easily identifiable

### 4. Error Handling
- **Validate inputs**: Check export options before processing
- **Handle failures**: Provide clear error messages
- **Recovery options**: Suggest solutions for common problems
- **Logging**: Track errors for debugging

## üöÄ Future Enhancements

### Planned Features
1. **Real PDF Generation**: Replace simulated generation with actual PDF library
2. **Background Workers**: Implement actual background isolates
3. **Cloud Integration**: Add cloud storage for exports
4. **Export Templates**: Predefined export styles
5. **Batch Export**: Export multiple sets simultaneously

### Customization Options
1. **Branding Themes**: Different branding for different user types
2. **Export Formats**: Support for other formats (Word, HTML)
3. **Advanced Styling**: Custom fonts, colors, and layouts
4. **Export Scheduling**: Schedule exports for off-peak hours

## üìö Additional Resources

### Documentation
- [PDF Export Models](lib/models/pdf_export_models.dart)
- [PDF Export Service](lib/services/pdf_export_service.dart)
- [PDF Audit Models](lib/models/pdf_audit_models.dart)
- [Storage Service](lib/services/storage_service.dart)

### Examples
- [Export Button Widgets](lib/widgets/mindload_pdf_export_button.dart)
- [Export Options Dialog](lib/widgets/pdf_export_options_dialog.dart)
- [Export Progress Dialog](lib/widgets/pdf_export_progress_dialog.dart)

### Tests
- [PDF Export Tests](test/pdf_export_test.dart)
- [Storage Service Tests](test/storage_service_test.dart)

---

**Note**: This integration guide covers the complete PDF export system. For specific implementation details, refer to the individual component files and tests.
